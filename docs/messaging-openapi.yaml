openapi: 3.1.0
info:
  title: ERP Messaging API (Strict Conversation Contract)
  version: 2.0.0
  description: Conversation-table-based messaging contract.
servers:
  - url: /api/messaging
components:
  schemas:
    StructuredError:
      type: object
      required: [status, error]
      properties:
        status: { type: integer }
        error:
          type: object
          required: [code, message, correlationId]
          properties:
            code: { type: string }
            message: { type: string }
            correlationId: { type: string }
    Conversation:
      type: object
      required: [id, company_id]
      properties:
        id: { type: integer }
        company_id: { type: integer }
        last_message_id: { type: integer, nullable: true }
        last_message_at: { type: string, format: date-time, nullable: true }
    Message:
      type: object
      required: [id, company_id, conversation_id, author_empid, body, created_at]
      properties:
        id: { type: integer }
        company_id: { type: integer }
        conversation_id: { type: integer }
        parent_message_id: { type: integer, nullable: true }
        body: { type: string }
        created_at: { type: string, format: date-time }
paths:
  /conversations:
    get:
      responses:
        '200': { description: latest-first conversation page }
    post:
      responses:
        '201': { description: conversation created (with optional initial message) }
  /conversations/{conversationId}/messages:
    get:
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: integer }
      responses:
        '200': { description: latest-first message page for one conversation }
    post:
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: integer }
      responses:
        '201': { description: timeline or reply message created in conversation }
